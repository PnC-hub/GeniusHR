// GeniusHR SaaS - Multi-tenant Database Schema
// Each tenant (studio/clinic) has isolated data

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & USERS
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts         Account[]
  sessions         Session[]
  tenantMembers    TenantMember[]
  legalAcceptances LegalAcceptance[]
}

enum UserRole {
  SUPER_ADMIN  // Platform owner (you)
  ADMIN        // Tenant admin (clinic owner)
  HR_MANAGER   // HR manager
  USER         // Regular employee
}

// ============================================
// MULTI-TENANCY
// ============================================

model Tenant {
  id               String   @id @default(cuid())
  name             String   // "Studio Dentistico Rossi"
  slug             String   @unique // "studio-rossi" for subdomain
  logo             String?
  primaryColor     String   @default("#2563eb")
  secondaryColor   String   @default("#10b981")
  customDomain     String?  @unique // "hr.studiorossi.it"

  // Subscription
  plan             Plan     @default(STARTER)
  stripeCustomerId String?  @unique
  subscriptionId   String?
  subscriptionStatus SubscriptionStatus @default(TRIAL)
  trialEndsAt      DateTime?

  // Settings
  timezone         String   @default("Europe/Rome")
  language         String   @default("it")

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  members          TenantMember[]
  employees        Employee[]
  documents        Document[]
  deadlines        Deadline[]
  performanceReviews PerformanceReview[]
  onboardingChecklists OnboardingChecklist[]
  gdprConsents     GdprConsent[]
  auditLogs        AuditLog[]

  // White-label parent (for consultants)
  parentTenantId   String?
  parentTenant     Tenant?  @relation("TenantHierarchy", fields: [parentTenantId], references: [id])
  childTenants     Tenant[] @relation("TenantHierarchy")
}

enum Plan {
  STARTER      // €29/mo - up to 5 employees
  PROFESSIONAL // €59/mo - up to 15 employees
  ENTERPRISE   // €99/mo - unlimited
  PARTNER      // €199/mo - white-label reseller
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
}

model TenantMember {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String
  role      TenantRole @default(EMPLOYEE)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
}

enum TenantRole {
  OWNER       // Can manage billing, delete tenant
  ADMIN       // Can manage employees, settings
  HR_MANAGER  // Can manage HR functions
  EMPLOYEE    // Read-only access to own data
}

// ============================================
// HR MANAGEMENT
// ============================================

model Employee {
  id              String   @id @default(cuid())
  tenantId        String

  // Personal Info
  firstName       String
  lastName        String
  fiscalCode      String?
  email           String?
  phone           String?
  address         String?
  birthDate       DateTime?
  birthPlace      String?

  // Employment Info
  hireDate        DateTime
  endDate         DateTime?
  contractType    ContractType @default(FULL_TIME)
  ccnlLevel       String?      // "3° Livello", "4° Super", etc.
  department      String?
  jobTitle        String?

  // Status
  status          EmployeeStatus @default(ACTIVE)
  probationEndsAt DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documents       Document[]
  deadlines       Deadline[]
  performanceReviews PerformanceReview[]
  onboardingItems OnboardingItem[]
  gdprConsents    GdprConsent[]

  @@index([tenantId])
}

enum ContractType {
  FULL_TIME
  PART_TIME
  APPRENTICE
  INTERNSHIP
  FIXED_TERM
  FREELANCE
}

enum EmployeeStatus {
  ACTIVE
  ON_LEAVE
  PROBATION
  TERMINATED
}

// ============================================
// DOCUMENTS
// ============================================

model Document {
  id          String   @id @default(cuid())
  tenantId    String
  employeeId  String?

  name        String
  type        DocumentType
  category    String?
  filePath    String
  fileSize    Int?
  mimeType    String?

  // GDPR Retention
  retentionYears Int?
  expiresAt    DateTime?

  uploadedBy   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee     Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([employeeId])
}

enum DocumentType {
  CONTRACT
  ID_DOCUMENT
  TRAINING_CERTIFICATE
  MEDICAL_CERTIFICATE
  DPI_RECEIPT
  PAYSLIP
  DISCIPLINARY
  GDPR_CONSENT
  OTHER
}

// ============================================
// DEADLINE TRACKING
// ============================================

model Deadline {
  id          String   @id @default(cuid())
  tenantId    String
  employeeId  String?

  title       String
  description String?
  type        DeadlineType
  dueDate     DateTime
  status      DeadlineStatus @default(PENDING)

  // Notification settings
  notify30Days Boolean @default(true)
  notify60Days Boolean @default(false)
  notify90Days Boolean @default(false)
  notifiedAt   DateTime?

  completedAt  DateTime?
  completedBy  String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee     Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([dueDate])
}

enum DeadlineType {
  TRAINING_EXPIRY
  MEDICAL_VISIT
  DPI_RENEWAL
  CONTRACT_EXPIRY
  PROBATION_END
  DOCUMENT_EXPIRY
  CUSTOM
}

enum DeadlineStatus {
  PENDING
  UPCOMING
  OVERDUE
  COMPLETED
  DISMISSED
}

// ============================================
// PERFORMANCE REVIEWS
// ============================================

model PerformanceReview {
  id          String   @id @default(cuid())
  tenantId    String
  employeeId  String

  reviewDate  DateTime
  reviewerId  String?

  // Scores (1-5)
  technicalSkills    Int?
  teamwork           Int?
  communication      Int?
  reliability        Int?
  growthPotential    Int?

  overallScore       Float?
  strengths          String? @db.Text
  improvements       String? @db.Text
  goals              String? @db.Text
  notes              String? @db.Text

  status      ReviewStatus @default(DRAFT)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([employeeId])
}

enum ReviewStatus {
  DRAFT
  COMPLETED
  ACKNOWLEDGED
}

// ============================================
// ONBOARDING
// ============================================

model OnboardingChecklist {
  id          String   @id @default(cuid())
  tenantId    String

  name        String
  description String?
  isDefault   Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items       OnboardingChecklistItem[]

  @@index([tenantId])
}

model OnboardingChecklistItem {
  id          String   @id @default(cuid())
  checklistId String

  title       String
  description String?
  category    String?  // "Documenti", "Formazione", "IT", etc.
  order       Int      @default(0)
  required    Boolean  @default(true)

  createdAt   DateTime @default(now())

  checklist   OnboardingChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  completions OnboardingItem[]
}

model OnboardingItem {
  id            String   @id @default(cuid())
  employeeId    String
  checklistItemId String

  completed     Boolean  @default(false)
  completedAt   DateTime?
  completedBy   String?
  notes         String?

  createdAt     DateTime @default(now())

  employee      Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  checklistItem OnboardingChecklistItem @relation(fields: [checklistItemId], references: [id], onDelete: Cascade)

  @@unique([employeeId, checklistItemId])
}

// ============================================
// BILLING & INVOICES (for your records)
// ============================================

model Invoice {
  id              String   @id @default(cuid())
  stripeInvoiceId String   @unique
  tenantId        String?

  amount          Int      // in cents
  currency        String   @default("eur")
  status          String
  paidAt          DateTime?

  createdAt       DateTime @default(now())
}

// ============================================
// LEGAL & COMPLIANCE (GDPR)
// ============================================

// Documenti legali versionati (Privacy Policy, ToS, DPA, Cookie Policy)
model LegalDocument {
  id          String            @id @default(cuid())
  type        LegalDocumentType
  version     String            // "1.0", "1.1", "2.0"
  title       String
  content     String            @db.Text
  summary     String?           @db.Text // Riassunto modifiche per nuove versioni
  effectiveAt DateTime
  isActive    Boolean           @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  acceptances LegalAcceptance[]

  @@unique([type, version])
  @@index([type, isActive])
}

enum LegalDocumentType {
  PRIVACY_POLICY
  TERMS_OF_SERVICE
  DPA
  COOKIE_POLICY
}

// Tracking accettazione documenti legali da parte degli utenti
model LegalAcceptance {
  id              String   @id @default(cuid())
  userId          String
  legalDocumentId String

  ipAddress       String?
  userAgent       String?
  acceptedAt      DateTime @default(now())

  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  legalDocument   LegalDocument @relation(fields: [legalDocumentId], references: [id])

  @@unique([userId, legalDocumentId])
  @@index([userId])
}

// Consensi GDPR specifici per dipendenti
model GdprConsent {
  id          String          @id @default(cuid())
  tenantId    String
  employeeId  String

  consentType GdprConsentType
  granted     Boolean
  purpose     String?         // Finalita specifica del consenso

  grantedAt   DateTime?
  revokedAt   DateTime?
  expiresAt   DateTime?

  // Tracciabilita raccolta consenso
  collectedBy String?         // User ID di chi ha raccolto il consenso
  method      String?         // "online", "paper", "verbal"

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, consentType])
  @@index([tenantId])
}

enum GdprConsentType {
  DATA_PROCESSING      // Trattamento dati personali base
  HEALTH_DATA          // Dati sanitari (art. 9 GDPR)
  MARKETING            // Comunicazioni marketing
  THIRD_PARTY_SHARING  // Condivisione con terze parti
  PHOTO_VIDEO          // Uso immagini/video
}

// Audit Log per tracciare tutte le operazioni (compliance GDPR Art. 32)
model AuditLog {
  id          String      @id @default(cuid())
  tenantId    String
  userId      String?     // Chi ha eseguito l'azione

  action      AuditAction
  entityType  String      // "Employee", "Document", "Consent", etc.
  entityId    String

  details     Json?       // Dettagli aggiuntivi
  oldValue    Json?       // Valore precedente (per update/delete)
  newValue    Json?       // Nuovo valore (per create/update)

  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([entityType, entityId])
  @@index([userId])
}

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  EXPORT
  LOGIN
  LOGOUT
  CONSENT_GRANTED
  CONSENT_REVOKED
  DOCUMENT_SIGNED
}

// Cookie Consent per visitatori (GDPR compliant)
model CookieConsent {
  id          String   @id @default(cuid())
  visitorId   String   @unique  // UUID generato client-side
  userId      String?           // Se utente loggato

  necessary   Boolean  @default(true)   // Sempre true, non disabilitabile
  analytics   Boolean  @default(false)
  marketing   Boolean  @default(false)
  preferences Boolean  @default(false)

  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
